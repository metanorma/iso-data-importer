= ISO Data Importer

image:https://img.shields.io/gem/v/iso-data-importer.svg["Gem Version", link="https://rubygems.org/gems/iso-data-importer"]
image:https://github.com/metanorma/iso-data-importer/actions/workflows/rake.yml/badge.svg["Build Status", link="https://github.com/metanorma/iso-data-importer/actions/workflows/rake.yml"]
image:https://img.shields.io/github/issues-pr-raw/metanorma/iso-data-importer.svg["Pull Requests", link="https://github.com/metanorma/iso-data-importer/pulls"]
image:https://img.shields.io/github/commits-since/metanorma/iso-data-importer/latest.svg["Commits since latest",link="https://github.com/metanorma/iso-data-importer/releases"]

== Purpose

ISO Data Importer is a Ruby gem that fetches and processes data from the
https://www.iso.org/open-data.html[ISO Open Data portal].

It provides structured access to ISO standards metadata, technical committee
information, and the International Classification for Standards (ICS), making
this data available in YAML and JSON formats for offline use and integration.

This gem is used to populate ISO-related data in the iso-open-dataset
repository.

== Data sources and licensing

=== ISO Open Data

This gem fetches data from the
https://www.iso.org/open-data.html[ISO Open Data portal]. The data it
generates is licensed under the ODC Attribution License (ODC-By) v1.0.

This work is based on the following datasets from ISO Open Data:

* https://www.iso.org/open-data.html#iso_deliverables_metadata[iso_deliverables_metadata] - ISO standards metadata (JSONL)
* https://www.iso.org/open-data.html#iso_technical_committees[iso_technical_committees] - Technical committee information (JSONL)
* https://www.iso.org/open-data.html#iso_ics[iso_ics] - International Classification for Standards (XML)

=== Attribution requirements

When using data generated by this gem, please include appropriate attribution
to https://www.iso.org/open-data.html[ISO Open Data] as required by the
https://opendatacommons.org/licenses/by/1-0/[ODC Attribution License (ODC-By) v1.0].

== Installation

Add this line to your application's Gemfile:

[source,ruby]
----
gem 'iso-data-importer'
----

And then execute:

[source,shell]
----
$ bundle install
----

Or install it yourself as:

[source,shell]
----
$ gem install iso-data-importer
----

== Usage

=== Command-line interface

The gem provides a CLI for easy data management.

==== Update all data

[example]
====
[source,shell]
----
# Basic update (uses cached files, exports to YAML)
$ iso-data-importer update_all

# Force fresh download
$ iso-data-importer update_all --force-download

# Export as JSON instead of YAML
$ iso-data-importer update_all --format=json

# Force download and export as JSON
$ iso-data-importer update_all -f -o json
----
====

==== Clean operations

[example]
====
[source,shell]
----
# Clean both cache and output files
$ iso-data-importer clean

# Clean only cached files
$ iso-data-importer clean --cache

# Clean only output files
$ iso-data-importer clean --output
----
====

==== Version information

[example]
====
[source,shell]
----
$ iso-data-importer version
----
====

=== Rake tasks

For integration with Ruby projects, Rake tasks are available:

[example]
====
[source,shell]
----
# Update all data (default task)
$ rake data:update_all

# Force download and specify format
$ rake "data:update_all[true,json]"

# Clean operations
$ rake data:clean_output    # Remove generated YAML/JSON files
$ rake data:clean_cache     # Remove cached downloads
$ rake data:clean           # Clean both
----
====

=== Ruby API

Use the gem programmatically in your Ruby code:

[example]
====
[source,ruby]
----
require 'iso/data/importer'

# Fetch all data types
data = Iso::Data::Importer::Scrapers.fetch_all(force_download: true)

# Access individual collections
deliverables = data[:deliverables]
committees = data[:technical_committees]
ics_entries = data[:ics_entries]

# Fetch specific data types
deliverables = Iso::Data::Importer::Scrapers.fetch_deliverables
committees = Iso::Data::Importer::Scrapers.fetch_technical_committees
ics = Iso::Data::Importer::Scrapers.fetch_ics_entries

# Export data
exporter = Iso::Data::Importer::Exporter.new
exporter.export_deliverables(deliverables, format: :yaml)
exporter.export_technical_committees(committees, format: :json)

# Manually parse JSONL/XML data
deliverables_data = Iso::Data::Importer::Models::DeliverablesCollection.from_jsonl('path/to/deliverables.jsonl')
committees_data = Iso::Data::Importer::Models::TechnicalCommitteesCollection.from_jsonl('path/to/committees.jsonl')
ics_data = Iso::Data::Importer::Models::IcsEntriesCollection.from_xml('path/to/ics.xml')
----
====

== Architecture

The gem follows a modular architecture with clear separation of concerns:

[source]
----
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   CLI/Rake      │───▶│   Orchestrator   │───▶│   Scrapers      │
│   Interface     │    │                  │    │   Module        │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                                         │
                       ┌─────────────────────────────────┼─────────────────────────────────┐
                       │                                 │                                 │
                       ▼                                 ▼                                 ▼
            ┌─────────────────┐              ┌─────────────────┐              ┌─────────────────┐
            │ Deliverables    │              │ Technical       │              │ ICS             │
            │ Scraper         │              │ Committees      │              │ Scraper         │
            │                 │              │ Scraper         │              │                 │
            └─────────────────┘              └─────────────────┘              └─────────────────┘
                       │                                 │                                 │
                       ▼                                 ▼                                 ▼
            ┌─────────────────┐              ┌─────────────────┐              ┌─────────────────┐
            │ Deliverable     │              │ Technical       │              │ ICS Entry       │
            │ Collection      │              │ Committee       │              │ Collection      │
            │                 │              │ Collection      │              │                 │
            └─────────────────┘              └─────────────────┘              └─────────────────┘
                       │                                 │                                 │
                       └─────────────────────────────────┼─────────────────────────────────┘
                                                         │
                                                         ▼
                                              ┌─────────────────┐
                                              │   Exporter      │
                                              │                 │
                                              └─────────────────┘
                                                         │
                                                         ▼
                                              ┌─────────────────┐
                                              │ YAML/JSON Files │
                                              │ (data/ dir)     │
                                              └─────────────────┘
----

=== Data flow

. **Input**: CLI commands or Rake tasks trigger the orchestrator
. **Download**: Scrapers fetch data from ISO Open Data URLs using HTTParty
. **Cache**: Files are cached locally in `tmp/iso_data_cache/`
. **Parse**: LutaML models deserialize JSONL and XML data
. **Export**: Structured data is serialized to YAML/JSON in `data/` directory

=== Components

* **CLI**: Thor-based command-line interface
* **Orchestrator**: Coordinates the entire workflow
* **Scrapers**: Download and parse data from ISO Open Data
* **Models**: LutaML-based data models with serialization support
* **Exporter**: Outputs structured data to files

== Data models

The gem provides comprehensive models for all ISO data types:

=== Deliverable

Represents ISO standards, technical reports, and other deliverables:

[example]
====
[source,ruby]
----
deliverable.id                 # Integer ID
deliverable.reference          # "ISO 9001:2015"
deliverable.deliverable_type   # "IS" (International Standard)
deliverable.publication_date   # Date object
deliverable.edition           # Edition number
deliverable.ics_codes         # Array of ICS classification codes
deliverable.owner_committee   # "ISO/TC 176/SC 2"
deliverable.current_stage     # Stage code (e.g., 6060 for published)
deliverable.pages.en          # Page count in English
deliverable.scope.en          # Scope description in English
----
====

=== Technical committee

Represents ISO technical committees, subcommittees, and working groups:

[example]
====
[source,ruby]
----
committee.id                  # Integer ID
committee.reference          # "ISO/TC 176"
committee.title.en           # Committee title in English
committee.secretariat.acronym # Secretariat organization
committee.creation_date      # Date established
committee.parent_id          # Parent committee ID (for SCs)
committee.children_ids       # Array of child committee IDs
committee.p_members          # Participating members
committee.o_members          # Observing members
----
====

=== ICS entry

Represents the hierarchical International Classification for Standards:

[example]
====
[source,ruby]
----
# Fields (top level: 01, 03, 07, etc.)
field.identifier             # "01"
field.title                  # Localized titles

# Groups (second level: 01.040, 03.080, etc.)
group.identifier             # "01.040"
group.field                  # Parent field
group.title                  # Localized titles

# Sub-groups (third level: 01.040.01, etc.)
subgroup.identifier          # "01.040.01"
subgroup.group              # Parent group
subgroup.title              # Localized titles
----
====

== Output structure

The gem generates three main output files in the `data/` directory:

`deliverables.yaml`:: Complete catalog of ISO deliverables
`committees.yaml`:: Technical committee structure and membership
`ics.yaml`:: International Classification for Standards hierarchy

=== Example output

[example]
====
[source,ruby]
----
Iso::Data::Importer::Models::DeliverableCollection.from_jsonl(IO.read('spec/fixtures/spec/fixtures/iso_deliverables_metadata.jsonl')).to_yaml
----

[source,yaml]
----
deliverables:
- ...
- ...
----
====

[example]
====
[source,ruby]
----
Iso::Data::Importer::Models::Deliverable.from_json(IO.read('spec/fixtures/62085.json')).to_yaml
----

[source,yaml]
----
- id: 62085
  deliverableType: IS
  reference: ISO 9001:2015
  publicationDate: '2015-09-22'
  edition: 5
  icsCode:
  - 03.120.10
  - 03.100.70
  ownerCommittee: ISO/TC 176/SC 2
  currentStage: 9092
  replaces:
  - 46486
  - 54538
  replacedBy:
  - 88464
  languages:
  - ar
  - en
  - es
  - fr
  - ru
  pages:
    en: 29
  scope:
    en: |
      <p>ISO 9001:2015 specifies requirements for a quality management system when an organization:</p>
      <p>a)    needs to demonstrate its ability to consistently provide products and services that meet customer and applicable statutory and regulatory requirements, and</p>
      <p>b)    aims to enhance customer satisfaction through the effective application of the system, including processes for improvement of the system and the assurance of conformity to customer and applicable statutory and regulatory requirements.</p>
      <p>All the requirements of ISO 9001:2015 are generic and are intended to be applicable to any organization, regardless of its type or size, or the products and services it provides.</p>
----
====


== Development

After checking out the repo, run `bundle install` to install dependencies.

Run tests with:

[source,shell]
----
$ bundle exec rspec
----

Update data locally:

[source,shell]
----
$ bundle exec rake data:update_all
----

== Copyright

This gem is developed, maintained and funded by
https://www.ribose.com[Ribose Inc.]

== License

The gem is available as open source under the terms of the
https://opensource.org/licenses/BSD-2-Clause[2-Clause BSD License].

The data generated by this gem is licensed under the
https://opendatacommons.org/licenses/by/1-0/[ODC Attribution License (ODC-By) v1.0]
as provided by https://www.iso.org/open-data.html[ISO Open Data].
